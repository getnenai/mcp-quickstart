---
description: "NenAI Python SDK reference for workflow authoring - execution environment, keyboard/mouse control, and common patterns"
alwaysApply: false
---

# NenAI Python SDK - Execution Environment & Best Practices

## Execution Environment

**CRITICAL:** Workflows run in **Linux containers** with the following characteristics:

- **OS:** Linux (Ubuntu-based)
- **Keyboard/Mouse:** xdotool (Linux tool for input control)
- **Browser:** Firefox
- **Display:** Headless X11 with VNC recording

### Platform Compatibility

**Always use Linux/Windows keyboard modifiers, NOT macOS:**

```python
# ❌ WRONG - macOS only (will crash with xdotool error)
keyboard.hotkey("command", "a")
keyboard.hotkey("command", "c")

# ✅ CORRECT - Linux/Windows (works in workflow container)
keyboard.hotkey("ctrl", "a")
keyboard.hotkey("ctrl", "c")
```

**Common key mappings:**
- Select All: `keyboard.hotkey("ctrl", "a")` (not "command")
- Copy: `keyboard.hotkey("ctrl", "c")` (not "command")
- Paste: `keyboard.hotkey("ctrl", "v")` (not "command")
- Cut: `keyboard.hotkey("ctrl", "x")` (not "command")
- Save: `keyboard.hotkey("ctrl", "s")` (not "command")

### xdotool Key Names

Valid key names for `keyboard.press()` and `keyboard.hotkey()`:

**Modifier keys:**
- `ctrl` - Control key (Linux/Windows)
- `shift` - Shift key
- `alt` - Alt key (Option on Mac)
- `super` - Windows/Super key (Command on Mac)

**Special keys:**
- `Return` or `Enter` - Enter/Return key
- `BackSpace` - Backspace key
- `Delete` - Delete key
- `Tab` - Tab key
- `Escape` - Escape key
- `space` - Space bar

**Navigation keys:**
- `Up`, `Down`, `Left`, `Right` - Arrow keys
- `Home`, `End` - Home/End keys
- `Page_Up`, `Page_Down` - Page up/down

**Function keys:**
- `F1`, `F2`, ..., `F12` - Function keys

## Common Patterns

### Clearing Input Fields

Always clear fields before typing new content:

```python
from nen.workflow import agent, keyboard

# Method 1: Select all + delete
agent("Click on the email field")
keyboard.hotkey("ctrl", "a")  # Select all text
keyboard.press("BackSpace")    # Delete selected text
keyboard.type(input.email)     # Type new content

# Method 2: Triple-click to select all + delete
agent("Triple-click the text field to select all")
keyboard.press("BackSpace")
keyboard.type(input.value)

# Method 3: For known content length, use multiple backspaces
agent("Click at the end of the text field")
for _ in range(50):  # Exceed expected length
    keyboard.press("BackSpace")
keyboard.type(input.text)
```

**Why clearing is important:**
- Fields may have default/pre-filled values
- Previous workflow runs may leave data
- Concatenation errors occur if you don't clear first

### Validation Strategies

**Check failure indicators BEFORE success indicators:**

```python
from nen.workflow import validate

# ❌ BAD - checks success first (prone to false positives)
if validate("Is there a dashboard?"):
    return Output(success=True)
elif validate("Are we still on login page?"):
    return Output(success=False, error="Still on login page")

# ✅ GOOD - checks failure first (more reliable)
if validate("Are we still on the login page?"):
    return Output(success=False, error="Login failed")
elif validate("Is there an error message visible?"):
    return Output(success=False, error="Error displayed")
elif validate("Did we navigate to a dashboard or different URL?"):
    return Output(success=True, message="Login successful")
else:
    return Output(success=False, error="Unable to determine state")
```

**Be specific in validation questions:**

```python
# ❌ VAGUE - prone to misinterpretation
validate("Is the page loaded?")
validate("Did it work?")

# ✅ SPECIFIC - clear and unambiguous
validate("Is the email input field visible with a 'Send login link' button?")
validate("Are we still on login.provetcloud.com URL?")
validate("Is there an 'Invalid email' error message visible?")
```

**Always default to failure when state is unclear:**

```python
# Conservative approach - if we can't confirm success, assume failure
if validate("Success indicator 1"):
    return Output(success=True)
elif validate("Success indicator 2"):
    return Output(success=True)
else:
    # Default to failure (conservative)
    return Output(success=False, error="Unable to verify success")
```

### Keyboard Typing with Delays

For sensitive fields (passwords, forms with validation), add delays:

```python
from nen.workflow import keyboard

# Standard typing (fast)
keyboard.type("username@example.com")

# Slower typing for better reliability (10ms between chars)
keyboard.type("password123", interval=0.01)

# Very slow for temperamental forms (50ms between chars)
keyboard.type("sensitive-data", interval=0.05)
```

### Mouse Coordinates

Direct mouse control when VLM-based agent() is unreliable:

```python
from nen.workflow import mouse, validate

# Wait for element to be visible first
if not validate("Is the submit button visible?"):
    return Output(success=False, error="Button not found")

# Click at specific coordinates
mouse.click_at(500, 400)

# Move and click
mouse.move(300, 200)
mouse.click()
```

**When to use direct mouse control:**
- Small clickable areas
- Elements without clear text labels
- Repeated clicks in same location
- Drawing or dragging operations

## Common Pitfalls

### 1. Platform-Specific Keyboard Commands

**Problem:** Using macOS "command" key in workflows

**Symptom:**
```
ERROR: xdotool key command failed: (symbol) No such key name 'command'
WorkflowError: Keyboard hotkey failed
```

**Solution:** Always use "ctrl" instead of "command"

### 2. Not Clearing Input Fields

**Problem:** Fields contain pre-existing content

**Symptom:** Concatenated text like "oldvaluetest_email"

**Solution:** Always select all + delete before typing

### 3. Validation False Positives

**Problem:** Workflow reports success when it actually failed

**Symptom:** VLM sees error messages but validation still passes

**Solution:** Check failure indicators first, be specific in questions

### 4. Timeout Issues

**Problem:** Operations take longer than expected

**Symptom:** Validation returns false before element appears

**Solution:** Increase timeout for slow operations:

```python
# Default timeout (10 seconds)
if not validate("Is page loaded?"):
    pass

# Increased timeout for slow pages (30 seconds)
if not validate("Is dashboard visible?", timeout=30):
    pass

# Custom timeouts for agent operations
agent("Fill out the form", max_iterations=20)  # More time/retries
```

### 5. Browser State Assumptions

**Problem:** Assuming clean browser state

**Symptom:** Unexpected cached data, cookies, or logged-in sessions

**Solution:** Always start fresh, check actual state:

```python
# Don't assume logged out
agent("Open Firefox and navigate to https://example.com")

# Check actual state first
if validate("Are we already logged in (dashboard visible)?"):
    return Output(success=True, message="Already logged in")

# Then proceed with login if needed
agent("Click login button")
# ...
```

## Debugging Tips

### Reading VLM Logs

When logs show VLM reasoning, look for:

1. **What the VLM saw:**
   ```
   "screenshot shows the login page at login.provetcloud.com with email field 
    containing 'test_email' (marked as invalid)"
   ```

2. **What action was planned:**
   ```
   "I will click on the email input field"
   ```

3. **Validation results:**
   ```
   validate("Are we still on login page?")
   Result: is_valid=true
   Match reason: "The page shows login form with logo..."
   ```

4. **Error messages:**
   ```
   ERROR: xdotool key command failed
   WorkflowError: Keyboard hotkey failed
   ```

### Common Error Patterns

**xdotool errors** → Platform-specific commands (use Linux conventions)

**WorkflowError: Validation timeout** → Increase timeout or check if element exists

**False validation success** → Make questions more specific, check failure first

**Concatenated text in fields** → Clear field before typing

## SDK Function Reference (Quick)

### agent(description, max_iterations=10)
Natural language action using vision language model.

```python
agent("Click the blue submit button")
agent("Fill in the entire registration form", max_iterations=20)
agent("Navigate to the settings page")
```

### validate(question, timeout=10)
Check UI state with yes/no question. Returns bool.

```python
if validate("Is the login form visible?"):
    # Proceed with login
    pass

if not validate("Is dashboard loaded?", timeout=30):
    return Output(success=False, error="Dashboard didn't load")
```

### extract(query, schema)
Extract structured data using JSON schema. Returns dict/list.

```python
data = extract(
    "What is the account balance?",
    schema={
        "type": "object",
        "properties": {
            "balance": {"type": "number"},
            "currency": {"type": "string"}
        },
        "required": ["balance"]
    }
)
# Returns: {"balance": 1250.50, "currency": "USD"}
```

### keyboard.type(text, interval=0.0)
Type text with optional delay between characters.

```python
keyboard.type("username@example.com")
keyboard.type("password", interval=0.01)  # 10ms delay per char
```

### keyboard.press(key)
Press a single key.

```python
keyboard.press("Return")
keyboard.press("BackSpace")
keyboard.press("Tab")
```

### keyboard.hotkey(*keys)
Press multiple keys simultaneously (modifier combos).

```python
keyboard.hotkey("ctrl", "a")    # Select all
keyboard.hotkey("ctrl", "c")    # Copy
keyboard.hotkey("ctrl", "v")    # Paste
keyboard.hotkey("shift", "Tab") # Reverse tab
```

### mouse.click()
Click at current mouse position.

```python
mouse.click()
```

### mouse.click_at(x, y)
Click at specific coordinates.

```python
mouse.click_at(500, 300)
```

### mouse.move(x, y)
Move mouse to coordinates.

```python
mouse.move(400, 200)
mouse.click()  # Then click
```

## For Complete Details

- **@workflow-guide-comprehensive** - Architecture, advanced patterns, debugging
- **@workflow-reference-detailed** - Complete SDK reference with all parameters
- **@workflow-core** - Quick start template and basic patterns
- **@mcp-platform-tools** - MCP tools for deployment, execution, debugging
