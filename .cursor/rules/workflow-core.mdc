---
description: "Core NenAI workflow authoring principles and SDK quick reference"
alwaysApply: true
---

# NenAI Python Workflow Authoring - Core Principles

You are an AI assistant helping to author NenAI computer use workflows using the **Python SDK** approach.

## ⚠️ CRITICAL: Execution Environment

**Workflows run in Linux containers**, NOT on your local machine. This means:

- **Use Linux keyboard commands:** `keyboard.hotkey("ctrl", "a")` ❌ NOT `"command"`
- **xdotool is the keyboard/mouse tool:** Linux key names only (ctrl, shift, alt, super)
- **Browser:** Firefox (headless with VNC recording)
- **OS:** Ubuntu-based Linux container

**Common mistake:** Using macOS "command" key crashes with `"No such key name 'command'"` error.

For detailed platform compatibility, see **@workflow-python-sdk**.

## Workflow Structure

Python-based workflows use the `nen.workflow` SDK.

**File structure:**
```
workflows/my_workflows/my-workflow/
└── workflow.py    # Python handler function
```

**Basic template:**
```python
"""
Workflow: [Name]

Description of what this workflow does.
"""
from nen.workflow import agent, validate, extract, keyboard, mouse
from pydantic import BaseModel, Field


class Input(BaseModel):
    """Input parameters for this workflow."""
    
    website_url: str = Field(default="https://example.com", min_length=1)


class Output(BaseModel):
    """Output returned by this workflow."""
    
    success: bool
    error: str | None = None


def run(input: Input) -> Output:
    """
    Main workflow entry point.
    
    Args:
        input: Pydantic model with workflow input parameters
    
    Returns:
        Output model with workflow results
    """
    # Workflow logic
    agent(f"Open Firefox and navigate to {input.website_url}")
    
    if not validate("Is the website loaded?"):
        return Output(success=False, error="Failed to load website")
    
    # Return results
    return Output(success=True)
```

## Python Syntax Rules

**CRITICAL: Use standard Python docstring syntax.**

Module-level docstrings MUST follow these rules:

✅ **CORRECT - Standard Python docstrings:**

```python
"""
Workflow: EzyVet Login Automation

Automates login to the EzyVet trial portal using provided credentials.
"""
```

❌ **WRONG - Do NOT escape characters in docstrings:**

```python
# This will cause syntax errors!
"""\nWorkflow: EzyVet Login Automation\n\nDescription here.\n\"""
```

**Rules:**
- Opening `"""` on its own line OR with first line of text
- Content starts on next line (no `\n` escape sequences)
- Closing `"""` on its own line (no backslash before quotes)
- Standard Python multi-line string syntax

**This is fundamental Python syntax, not NenAI-specific. Always generate valid Python code.**

## CRITICAL: Validation Rule

**After ANY change to workflow.py, you MUST call `nen_validate()`:**

```python
# Read the workflow file
workflow_content = Read("workflows/my_workflows/[workflow-name]/workflow.py")

# Validate it
nen_validate(content=workflow_content, filename="workflow.py")
```

This catches errors before deployment and ensures the workflow will execute correctly.

## SDK Primitives Quick Reference

### agent(description, max_iterations=10)
Execute natural language action using VLM.
```python
agent("Click the submit button")
agent("Fill in the entire form", max_iterations=20)
```

### validate(question, timeout=10)
Check UI state with yes/no question.
```python
if validate("Is the login form visible?"):
    # Proceed
    pass
```

### extract(query, schema)
Extract structured data using JSON schema.
```python
data = extract(
    "What is the account balance?",
    schema={
        "type": "object",
        "properties": {"balance": {"type": "number"}},
        "required": ["balance"]
    }
)
```

### mouse
Direct mouse control (no VLM).
```python
from nen.workflow import mouse

mouse.click_at(500, 300)
mouse.move(400, 200)
```

### keyboard
Direct keyboard control (no VLM). **Use Linux key names only.**
```python
from nen.workflow import keyboard

keyboard.type("hello@example.com")
keyboard.press("Return")
keyboard.hotkey("ctrl", "a")  # Select all (Linux: ctrl, NOT command)
keyboard.hotkey("ctrl", "c")  # Copy
keyboard.press("BackSpace")   # Delete
```

## Common Patterns

### Browser Automation
```python
agent("Open Firefox")
if not validate("Is Firefox open?", timeout=10):
    return Output(success=False, error="Failed to open browser")

agent(f"Navigate to {input.url}")
if not validate("Is page loaded?", timeout=20):
    return Output(success=False, error="Failed to load page")
```

### Login Workflow
```python
agent("Navigate to login page")
if not validate("Is login form visible?"):
    return Output(success=False, error="Login page not found")

# Fill username field - clear existing content first
agent("Click username field")
keyboard.hotkey("ctrl", "a")  # Select all (Linux-compatible)
keyboard.press("BackSpace")   # Clear field
keyboard.type(input.username)

# Fill password field - clear existing content first
agent("Click password field")
keyboard.hotkey("ctrl", "a")  # Select all
keyboard.press("BackSpace")   # Clear field
keyboard.type(input.password, interval=0.01)

agent("Click login button")

# Check failure indicators FIRST (more reliable)
if validate("Are we still on the login page?", timeout=10):
    return Output(success=False, error="Login failed - still on login page")
elif validate("Is there an error message visible?"):
    return Output(success=False, error="Login failed - error message displayed")
elif validate("Is dashboard visible?", timeout=20):
    return Output(success=True, message="Login successful")
else:
    return Output(success=False, error="Unable to verify login state")
```

### Data Extraction
```python
if not validate("Is the data table visible?"):
    return Output(success=False, error="Table not found")

data = extract(
    "Extract all rows from the table",
    schema={
        "type": "array",
        "items": {
            "type": "object",
            "properties": {
                "name": {"type": "string"},
                "value": {"type": "number"}
            }
        }
    }
)

return Output(success=True, data=data)
```

## Best Practices

1. **Use Pydantic models** - Define `Input` and `Output` classes with type hints and validation

2. **Validate before deploying** - Always run `nen_validate()` tool before publishing workflows

3. **Use Linux keyboard commands** - Always use `"ctrl"` not `"command"` (workflows run in Linux containers)

4. **Clear fields before typing** - Always select all (`ctrl+a`) + delete before typing into input fields

5. **Check failure BEFORE success** - In validation logic, check for error indicators first, then success indicators

6. **Be specific in validations** - "Is there an 'Invalid email' error?" not "Did it work?"

7. **Be specific in agent() descriptions** - "Click the blue 'Submit' button in the bottom right" not "Click submit"

8. **Validate before extracting** - Always check UI state before data extraction

9. **Return structured Output** - Use Pydantic `Output` model, include `success: bool` field

10. **Use Field validation** - `Field(default="...", min_length=1, ge=0)` for input validation

11. **Don't log sensitive data** - Redact passwords, tokens, and credentials

12. **Default to failure when unclear** - If state is ambiguous, return `Output(success=False, error="...")`

## For More Details

When working on complex workflows or need detailed guidance:
- **@workflow-guide-comprehensive** - Architecture, advanced patterns, debugging
- **@workflow-reference-detailed** - Complete SDK reference with examples

---

**Note:** This project uses the Python SDK approach for workflows, NOT the FSM (Finite State Machine) JSON approach.
